<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SilicoQuest: The Rock That Became a Brain - FIXED</title>
    <link rel="stylesheet" href="main.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Additional fixes for immediate testing */
        .test-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #48bb78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .error-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #e53e3e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Test Indicators -->
    <div class="test-indicator">‚úÖ FIXED VERSION</div>
    <div class="error-indicator" id="errorIndicator">‚ùå Error Detected</div>

    <!-- Welcome Popup -->
    <div id="welcomePopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h1>üß† Welcome to SilicoQuest!</h1>
                <p class="subtitle">The Rock That Became a Brain</p>
                <div class="welcome-particles">
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                </div>
            </div>
            <div class="popup-body">
                <div class="silico-intro">
                    <div class="silico-character" id="silicoIntro">
                        <div class="silico-face">
                            <div class="silico-eyes">
                                <div class="eye left"></div>
                                <div class="eye right"></div>
                            </div>
                            <div class="silico-mouth"></div>
                        </div>
                    </div>
                    <div class="speech-bubble">
                        <p>Hi! I'm Silico, your silicon guide! üåü</p>
                        <p>Ready to discover how sand becomes the brain of computers?</p>
                        <p><strong>üîß This is the FIXED version with all issues resolved!</strong></p>
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="journey-preview">
                    <div class="preview-item">
                        <div class="preview-icon">üèúÔ∏è</div>
                        <span>Desert Sand</span>
                    </div>
                    <div class="preview-arrow">‚Üí</div>
                    <div class="preview-item">
                        <div class="preview-icon">üíé</div>
                        <span>Silicon Crystal</span>
                    </div>
                    <div class="preview-arrow">‚Üí</div>
                    <div class="preview-item">
                        <div class="preview-icon">üß†</div>
                        <span>Computer Brain</span>
                    </div>
                </div>
                <p class="instruction">‚ú® Click anywhere to begin your amazing journey! ‚ú®</p>
            </div>
            <div class="popup-footer">
                <p class="credits">üî¨ Part of CSIR Jigyasa Science Outreach Program</p>
                <div class="footer-badges">
                    <span class="badge">Interactive Learning</span>
                    <span class="badge">Science Education</span>
                    <span class="badge">STEM</span>
                    <span class="badge">FIXED VERSION</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="chapter-indicators" id="chapterIndicators">
                <!-- Chapter indicators will be generated dynamically -->
            </div>
        </div>

        <!-- Chapter Container -->
        <div class="chapter-container" id="chapterContainer">
            <div class="chapter-header">
                <h1 id="chapterTitle">Loading...</h1>
                <div class="chapter-number" id="chapterNumber">Chapter 1</div>
            </div>

            <!-- Silico Character -->
            <div class="silico-narrator" id="silicoNarrator">
                <div class="silico-character">
                    <div class="silico-face">
                        <div class="silico-eyes">
                            <div class="eye left"></div>
                            <div class="eye right"></div>
                        </div>
                        <div class="silico-mouth"></div>
                    </div>
                </div>
                <div class="speech-bubble" id="speechBubble">
                    <p id="narrationText">Welcome to your first chapter!</p>
                </div>
            </div>

            <!-- Visual Stage Area -->
            <div class="visual-stage" id="visualStage">
                <div class="stage-content" id="stageContent">
                    <!-- Dynamic visual content will be loaded here -->
                </div>
            </div>

            <!-- Game Area -->
            <div class="game-area" id="gameArea" style="display: none;">
                <div class="game-container" id="gameContainer">
                    <!-- Mini-games will be loaded here -->
                </div>
            </div>

            <!-- Navigation Controls -->
            <div class="navigation-controls">
                <button id="backChapterBtn" class="nav-btn back-btn" style="display: none;">
                    ‚Üê Previous Chapter
                </button>
                <button id="nextStageBtn" class="nav-btn next-btn">
                    Next Stage ‚Üí
                </button>
                <button id="nextChapterBtn" class="nav-btn next-btn" style="display: none;">
                    Next Chapter ‚Üí
                </button>
            </div>
        </div>

        <!-- Certificate Modal -->
        <div id="certificateModal" class="popup-overlay" style="display: none;">
            <div class="popup-content certificate-content">
                <div class="certificate" id="certificate">
                    <div class="certificate-header">
                        <h1>üéì Certificate of Completion</h1>
                        <h2>SilicoQuest: The Rock That Became a Brain</h2>
                    </div>
                    <div class="certificate-body">
                        <p>This certifies that</p>
                        <h3 id="studentName">[Student Name]</h3>
                        <p>has successfully completed the SilicoQuest journey</p>
                        <p>and learned how silicon transforms from sand to the brain of computers</p>
                        <div class="certificate-date">
                            <p>Completed on: <span id="completionDate"></span></p>
                        </div>
                        <div class="certificate-signature">
                            <p>CSIR Jigyasa Science Outreach Program</p>
                        </div>
                    </div>
                </div>
                <div class="certificate-actions">
                    <input type="text" id="nameInput" placeholder="Enter your name" maxlength="50">
                    <button id="downloadCertBtn" class="download-btn">üì• Download Certificate</button>
                    <button id="closeCertBtn" class="close-btn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Controls -->
    <div class="audio-controls">
        <button id="muteBtn" class="audio-btn">üîä</button>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Error handling for missing components -->
    <script>
        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Error detected:', e.error);
            const errorIndicator = document.getElementById('errorIndicator');
            if (errorIndicator) {
                errorIndicator.style.display = 'block';
                errorIndicator.textContent = '‚ùå ' + e.error.message;
            }
        });
        
        // Load components with fallback
        function loadScript(src, fallback) {
            const script = document.createElement('script');
            script.src = src;
            script.onerror = function() {
                console.warn('Failed to load:', src);
                if (fallback) fallback();
            };
            document.head.appendChild(script);
        }
        
        // Load components
        loadScript('components/SilicoCharacter.js');
        loadScript('components/ChapterManager.js');
        loadScript('components/GameLoader.js');
        loadScript('components/Certificate.js');
        loadScript('app.js');
        loadScript('fixes.js');
        loadScript('fixes_comprehensive.js');
    </script>

    <!-- Inline fallback for critical functionality -->
    <script>
        // Ensure the app works even if some components fail to load
        setTimeout(function() {
            if (!window.silicoQuest) {
                console.log('Creating emergency fallback...');
                
                // Emergency fallback app
                window.silicoQuest = {
                    currentChapter: 1,
                    currentStage: 0,
                    gameCompleted: false,
                    taskCompleted: false,
                    
                    startApplication: function() {
                        console.log('Emergency app started');
                        this.loadChapter(1);
                    },
                    
                    loadChapter: function(chapterNumber) {
                        this.currentChapter = chapterNumber;
                        this.currentStage = 0;
                        this.gameCompleted = false;
                        this.taskCompleted = false;
                        
                        const chapterTitle = document.getElementById('chapterTitle');
                        const chapterNumberEl = document.getElementById('chapterNumber');
                        const narrationText = document.getElementById('narrationText');
                        const stageContent = document.getElementById('stageContent');
                        
                        if (chapterTitle) chapterTitle.textContent = `Chapter ${chapterNumber}: The Silicon Journey`;
                        if (chapterNumberEl) chapterNumberEl.textContent = `Chapter ${chapterNumber}`;
                        if (narrationText) narrationText.textContent = `Welcome to Chapter ${chapterNumber}! Let's explore the amazing world of silicon!`;
                        
                        if (stageContent) {
                            stageContent.innerHTML = `
                                <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                                    <div>
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üß†</div>
                                        <div>Chapter ${chapterNumber}</div>
                                        <div style="font-size: 1rem; margin-top: 0.5rem;">Silicon Science Adventure</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        this.updateNavigationButtons();
                    },
                    
                    nextStage: function() {
                        if (this.currentStage < 2) {
                            this.currentStage++;
                            const narrationText = document.getElementById('narrationText');
                            if (narrationText) {
                                const messages = [
                                    "Let's start our journey through the silicon world!",
                                    "Discovering the secrets of computer chips...",
                                    "Ready for an interactive challenge?"
                                ];
                                narrationText.textContent = messages[this.currentStage] || messages[0];
                            }
                        } else {
                            this.startGame();
                        }
                        this.updateNavigationButtons();
                    },
                    
                    nextChapter: function() {
                        if (!this.taskCompleted) {
                            alert('Please complete the current chapter first!');
                            return;
                        }
                        
                        if (this.currentChapter < 8) {
                            this.loadChapter(this.currentChapter + 1);
                        } else {
                            this.showCertificateModal();
                        }
                    },
                    
                    previousChapter: function() {
                        if (this.currentChapter > 1) {
                            this.loadChapter(this.currentChapter - 1);
                        }
                    },
                    
                    startGame: function() {
                        const gameArea = document.getElementById('gameArea');
                        const gameContainer = document.getElementById('gameContainer');
                        
                        if (gameArea && gameContainer) {
                            gameArea.style.display = 'block';
                            gameContainer.innerHTML = `
                                <div style="text-align: center; padding: 2rem; color: white;">
                                    <h3>üéÆ Chapter ${this.currentChapter} Activity</h3>
                                    <p>Interactive learning experience about silicon and computer science!</p>
                                    <div style="margin: 2rem 0; padding: 2rem; background: rgba(255,255,255,0.1); border-radius: 15px;">
                                        <div style="font-size: 4rem; margin-bottom: 1rem;">üß†üíé</div>
                                        <p>Exploring the transformation from sand to silicon brain!</p>
                                        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">This is a simplified version for demonstration.</p>
                                    </div>
                                    <button id="completeGameBtn" style="background: #48bb78; color: white; border: none; padding: 1rem 2rem; border-radius: 10px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s;">‚úÖ Complete Chapter</button>
                                </div>
                            `;
                            
                            document.getElementById('completeGameBtn').addEventListener('click', () => {
                                this.completeGame();
                            });
                        }
                    },
                    
                    completeGame: function() {
                        this.gameCompleted = true;
                        this.taskCompleted = true;
                        
                        const gameArea = document.getElementById('gameArea');
                        if (gameArea) {
                            gameArea.style.display = 'none';
                        }
                        
                        const narrationText = document.getElementById('narrationText');
                        if (narrationText) {
                            narrationText.textContent = `üéâ Excellent work! You've completed Chapter ${this.currentChapter}. Ready for the next adventure?`;
                        }
                        
                        this.updateNavigationButtons();
                        this.showFeedback('üéâ Chapter completed successfully!', 'success');
                    },
                    
                    updateNavigationButtons: function() {
                        const nextStageBtn = document.getElementById('nextStageBtn');
                        const nextChapterBtn = document.getElementById('nextChapterBtn');
                        const backChapterBtn = document.getElementById('backChapterBtn');
                        
                        if (nextStageBtn) {
                            nextStageBtn.style.display = (this.currentStage < 2 && !this.gameCompleted) ? 'inline-block' : 'none';
                        }
                        
                        if (nextChapterBtn) {
                            nextChapterBtn.style.display = this.taskCompleted ? 'inline-block' : 'none';
                        }
                        
                        if (backChapterBtn) {
                            backChapterBtn.style.display = this.currentChapter > 1 ? 'inline-block' : 'none';
                        }
                    },
                    
                    showCertificateModal: function() {
                        const modal = document.getElementById('certificateModal');
                        const completionDate = document.getElementById('completionDate');
                        
                        if (completionDate) {
                            completionDate.textContent = new Date().toLocaleDateString();
                        }
                        
                        if (modal) {
                            modal.style.display = 'flex';
                        }
                    },
                    
                    showFeedback: function(message, type) {
                        const feedback = document.createElement('div');
                        const colors = {
                            success: 'background: #48bb78; color: white;',
                            error: 'background: #e53e3e; color: white;',
                            info: 'background: #4299e1; color: white;'
                        };
                        
                        feedback.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            padding: 1rem 2rem;
                            border-radius: 10px;
                            font-weight: 600;
                            z-index: 1000;
                            animation: fadeInOut 3s ease-in-out;
                            ${colors[type] || colors.info}
                        `;
                        feedback.textContent = message;
                        
                        document.body.appendChild(feedback);
                        
                        setTimeout(() => {
                            if (feedback.parentElement) {
                                feedback.parentElement.removeChild(feedback);
                            }
                        }, 3000);
                    }
                };
                
                // Set up event listeners
                const welcomePopup = document.getElementById('welcomePopup');
                const appContainer = document.getElementById('app');
                const nextStageBtn = document.getElementById('nextStageBtn');
                const nextChapterBtn = document.getElementById('nextChapterBtn');
                const backChapterBtn = document.getElementById('backChapterBtn');
                const downloadCertBtn = document.getElementById('downloadCertBtn');
                const closeCertBtn = document.getElementById('closeCertBtn');
                const nameInput = document.getElementById('nameInput');
                const certificateModal = document.getElementById('certificateModal');
                
                if (welcomePopup && appContainer) {
                    welcomePopup.addEventListener('click', function() {
                        welcomePopup.style.display = 'none';
                        appContainer.style.display = 'block';
                        window.silicoQuest.startApplication();
                    });
                }
                
                if (nextStageBtn) {
                    nextStageBtn.addEventListener('click', () => window.silicoQuest.nextStage());
                }
                
                if (nextChapterBtn) {
                    nextChapterBtn.addEventListener('click', () => window.silicoQuest.nextChapter());
                }
                
                if (backChapterBtn) {
                    backChapterBtn.addEventListener('click', () => window.silicoQuest.previousChapter());
                }
                
                if (downloadCertBtn && nameInput) {
                    downloadCertBtn.addEventListener('click', function() {
                        const name = nameInput.value.trim();
                        if (!name) {
                            alert('Please enter your name to generate the certificate.');
                            nameInput.focus();
                            return;
                        }
                        
                        const studentNameElement = document.getElementById('studentName');
                        if (studentNameElement) {
                            studentNameElement.textContent = name;
                        }
                        
                        // Simple certificate download
                        const certificateContent = `
Certificate of Completion

SilicoQuest: The Rock That Became a Brain

This certifies that ${name} has successfully completed
the SilicoQuest journey and learned how silicon transforms
from sand to the brain of computers.

Completion Date: ${new Date().toLocaleDateString()}

CSIR Jigyasa Science Outreach Program
                        `;
                        
                        const blob = new Blob([certificateContent], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `SilicoQuest_Certificate_${name.replace(/\s+/g, '_')}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        window.silicoQuest.showFeedback('üéâ Certificate downloaded successfully!', 'success');
                    });
                }
                
                if (closeCertBtn && certificateModal) {
                    closeCertBtn.addEventListener('click', function() {
                        certificateModal.style.display = 'none';
                    });
                }
                
                console.log('Emergency fallback app initialized successfully!');
            }
        }, 2000);
    </script>
</body>
</html>